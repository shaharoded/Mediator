<?xml version="1.0" encoding="UTF-8"?>
<!-- In this case must ignore-unfulfilled-anchors="true" otherwise unfulfilled anchors emit 'False' / 0.0, which is the opposite of what we want -->
<!-- We are effectively only outputting compliance for fulfilled anchors, meaning cases where dose was given -->
<pattern name="REDUCE_INSULIN_ON_HYPOGLYCEMIA_PATTERN_2" concept-type="local-pattern" ignore-unfulfilled-anchors="true">
    <categories>RoutineTreatment</categories>
    <description>Captures if long term INSULIN (BASAL) was reduced after low glucose measured (if given within 24h of event)</description>
    <!-- Attributes must be 1D. Can reference all tak types for complex cases. -->
    <derived-from>
        <attribute name="DISGLYCEMIA_EVENT" tak="event" ref="A2"/>
        <attribute name="BASAL_BITZUA_RATIO" tak="raw-concept" idx="0" ref="E1"/>
    </derived-from>

    <!-- Rules always share "OR" relationship. To create more complex patterns, reference a pattern in a different pattern TAK -->
    <abstraction-rules>
        <rule>
            <!-- Rule 2: No overlap within low glucose context, but did we reduce dose outside this context within 24h? -->
            <!-- This is only relevant if glucose level balanced back, but insulin dose was given -->
            <!-- 24h after hypoglycemia event: Don't care about the insulin dose -->
            <temporal-relation how='before' max-distance='24h'>
                <anchor>
                    <attribute ref="A2">
                        <allowed-value equal="Hypoglycemia"/>
                    </attribute>
                </anchor>
                <event select='first'>
                    <attribute ref="E1">
                        <allowed-value min="0"/>
                    </attribute>
                </event>
            </temporal-relation>

            <!-- OPTIONAL: Compliance function to define fuzzy time window -->
            <compliance-function>
                <value-constraint-compliance>
                    <target>
                        <attribute ref="E1"/>
                    </target>
                    <function name="id">
                        <!-- Any decrease in dose will is good compliance -->
                        <trapez trapezA="0" trapezB="0" trapezC="0.99" trapezD="1"/>
                    </function>
                </value-constraint-compliance>
            </compliance-function>
        </rule>
    </abstraction-rules>
</pattern>